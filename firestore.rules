rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // === USUÁRIOS - Acesso total para usuários autenticados ===
    match /usuarios/{userId} {
      // Leitura e escrita para todos os usuários autenticados
      allow read, write: if request.auth != null;
    }

    // === ESTAÇÕES CLÍNICAS - Leitura para usuários autenticados, escrita apenas admin ===
    match /estacoes_clinicas/{stationId} {
      // Leitura para todos os usuários autenticados
      allow read: if request.auth != null;
      // Escrita para administradores ou usuário especial (agente)
      allow write: if request.auth != null && hasFullAccess();
    }

    // === ACESSO APENAS PARA USUÁRIOS AUTENTICADOS ===
    // Acesso público removido para reduzir custos desnecessários
    
    // === COLEÇÕES ADMINISTRATIVAS - ADMINS E USUÁRIO ESPECIAL ===
    match /admin_logs/{logId} {
      allow read, write: if request.auth != null && hasFullAccess();
    }

    match /system_config/{configId} {
      allow read, write: if request.auth != null && hasFullAccess();
    }

    // === QUESTÕES - Leitura para todos, escrita para Admins/Serviço/Agente, comentários para usuários ===
    match /questoes/{questaoId} {
      allow read: if request.auth != null;

      // Criação e deleção por Admins, Conta de Serviço ou usuário especial (agente)
      allow create, delete: if request.auth != null && (hasFullAccess() || request.auth.token.email != null);

      // Atualização: Admins/Serviço/Agente podem mudar tudo. Usuários só podem adicionar comentários.
      allow update: if request.auth != null &&
                      (
                        (hasFullAccess() || request.auth.token.email != null) ||
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['comments'])
                      );
    }
    
    // === TODAS AS OUTRAS COLEÇÕES - Acesso total ===
    match /avaliacoes/{avaliacaoId} {
      allow read, write: if request.auth != null;
    }
    
    match /sessoes/{sessionId} {
      allow read, write: if request.auth != null;
    }
    
    match /chatMessages/{messageId} {
      allow read, write: if request.auth != null;
    }
    
    // === CHAT PRIVADO - Acesso para usuários autenticados ===
    // Segurança garantida pelo frontend: usuários só acessam via interface controlada
    match /{chatCollection}/{messageId} {
      allow read, write: if request.auth != null && 
        chatCollection.matches('chatPrivado_.*');
    }
    
    // === CONVITES DE SIMULAÇÃO - Acesso controlado ===
    match /simulationInvites/{inviteId} {
      // Leitura: candidato ou remetente
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.candidateUid || 
         request.auth.uid == resource.data.senderUid);
      
      // Criação: apenas remetente
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.senderUid;
      
      // Atualização: candidato pode mudar status, remetente pode mudar outros campos
      allow update: if request.auth != null && 
        ((request.auth.uid == resource.data.candidateUid && 
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status'])) ||
         request.auth.uid == resource.data.senderUid);
      
      // Deleção: apenas remetente ou candidato
      allow delete: if request.auth != null && 
        (request.auth.uid == resource.data.candidateUid || 
         request.auth.uid == resource.data.senderUid);
    }
    
    // === REGRA ESPECÍFICA PARA TESTE DE CONEXÃO ===
    match /test_connection/{docId} {
      allow read, write: if request.auth != null;
    }
    
    // === REGRA GERAL PARA OUTRAS COLEÇÕES ===
    match /{collection}/{docId} {
      allow read, write: if request.auth != null &&
        !(collection == 'admin_logs' || collection == 'system_config') ||
        (request.auth != null && hasFullAccess());
    }
    
    // === FUNÇÕES DE CONTROLE ===

    // Função para verificar se é administrador
    function isAdmin() {
      return request.auth != null && request.auth.uid in [
        'KiSITAxXMAY5uU3bOPW5JMQPent2',  // Taís Zocche
        'RtfNENOqMUdw7pvgeeaBVSuin662',  // Usuário atual
        'anmxavJdQdgZ16bDsKKEKuaM4FW2',  // Admin 2
        'gb8MEg8UMmOOUhiBu1A2EY6GkX52',  // Admin 3
        'lNwhdYgMwLhS1ZyufRzw9xLD10y1',  // stefferson ferraz
        'CUdflZgyx5SOROyjbvZ1WpIVT2w2'           // Usuário especial para agentes VS Code
      ];
    }

    // Função para verificar se é usuário especial (agente)
    function isAgentUser() {
      return request.auth != null &&
             request.auth.token.email == 'agent@revalidafacil.com';
    }

    // Função para verificar se tem acesso irrestrito (admin ou agente)
    function hasFullAccess() {
      return isAdmin() || isAgentUser();
    }
  }
}
