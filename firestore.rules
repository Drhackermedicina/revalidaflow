rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // === TODOS OS USUÁRIOS PRECISAM ESTAR AUTENTICADOS ===
    // === USUÁRIOS LOGADOS PODEM ACESSAR QUALQUER ÁREA EXCETO ADMINISTRAÇÃO ===

    // === USUÁRIOS ===
    match /usuarios/{userId} {
      allow read, write: if request.auth != null; // Apenas usuários autenticados
    }

    // === ESTAÇÕES CLÍNICAS ===
    match /estacoes_clinicas/{stationId} {
      allow read: if request.auth != null; // Apenas usuários autenticados podem ver
      allow write: if request.auth != null && hasFullAccess(); // Apenas admins podem editar
    }

    // === QUESTÕES ===
    match /questoes/{questaoId} {
      allow read, write: if request.auth != null; // Usuários autenticados podem acessar tudo
    }

    // === NOTIFICAÇÕES - Acesso para usuários autenticados ===
    match /notificacoes/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      match /{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // === CHAT MESSAGES - Acesso para usuários autenticados ===
    match /chatMessages/{messageId} {
      allow read, write: if request.auth != null;
    }

    // === SESSÕES - Acesso para usuários autenticados ===
    match /sessoes/{sessionId} {
      allow read, write: if request.auth != null;
    }

    // === AVALIAÇÕES - Acesso para usuários autenticados ===
    match /avaliacoes/{avaliacaoId} {
      allow read, write: if request.auth != null;
    }

    // === CONVITES DE SIMULAÇÃO ===
    match /simulationInvites/{inviteId} {
      allow read: if request.auth != null &&
        (request.auth.uid == resource.data.candidateUid ||
         request.auth.uid == resource.data.senderUid);
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.senderUid;
      allow update: if request.auth != null &&
        ((request.auth.uid == resource.data.candidateUid &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status'])) ||
         request.auth.uid == resource.data.senderUid);
      allow delete: if request.auth != null &&
        (request.auth.uid == resource.data.candidateUid ||
         request.auth.uid == resource.data.senderUid);
    }

    // === CONVITES DE ACESSO ===
    match /accessInvites/{inviteId} {
      allow read: if request.auth != null && (
        hasFullAccess() ||
        (resource.data.redeemedByUid != null && request.auth.uid == resource.data.redeemedByUid)
      );
      allow create, update, delete: if request.auth != null && hasFullAccess();
    }

    // === CHAT PRIVADO ===
    match /{chatCollection}/{messageId} {
      allow read, write: if request.auth != null &&
        chatCollection.matches('chatPrivado_.*');
    }

    // === COLEÇÕES ADMINISTRATIVAS ===
    match /admin_logs/{logId} {
      allow read, write: if request.auth != null && hasFullAccess();
    }

    match /system_config/{configId} {
      allow read, write: if request.auth != null && hasFullAccess();
    }

    // === QUESTÕES DESCRITIVAS ===
    match /descriptiveQuestions/{questionId} {
      allow read: if request.auth != null; // Qualquer usuário autenticado pode ler
      allow write: if request.auth != null && hasFullAccess(); // Apenas admins podem escrever
    }

    // === RESPOSTAS DESCRITIVAS DOS USUÁRIOS ===
    match /userDescriptiveAnswers/{answerId} {
      // Usuários autenticados podem ler apenas seus próprios registros
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;

      // Usuários autenticados podem criar apenas registros para si mesmos
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;

      // Ninguém pode atualizar registros (imutabilidade para integridade do histórico)
      allow update: if false;

      // Ninguém pode deletar registros (preservação do histórico)
      allow delete: if false;

      // Administradores podem ler todos os registros para análise/analytics
      allow read: if request.auth != null && hasFullAccess();
    }

    // === TESTE DE CONEXÃO ===
    match /test_connection/{docId} {
      allow read, write: if request.auth != null;
    }

    // === REGRA GERAL - USUÁRIOS AUTENTICADOS ===
    match /{collection}/{docId} {
      allow read, write: if request.auth != null; // Todos os usuários autenticados podem acessar
    }

    // === FUNÇÕES DE CONTROLE ===
    function isAdmin() {
      return request.auth != null && request.auth.uid in [
        'KiSITAxXMAY5uU3bOPW5JMQPent2',  // Taís Zocche
        'RtfNENOqMUdw7pvgeeaBVSuin662',  // Usuário atual
        'anmxavJdQdgZ16bDsKKEKuaM4FW2',  // Admin 2
        'gb8MEg8UMmOOUhiBu1A2EY6GkX52',  // Admin 3
        'lNwhdYgMwLhS1ZyufRzw9xLD10y1',  // stefferson ferraz
        'CUdflZgyx5SOROyjbvZ1WpIVT2w2'   // Usuário especial para agentes VS Code
      ];
    }

    function isAgentUser() {
      return request.auth != null &&
             request.auth.token.email == 'agent@revalidaflow.com';
    }

    function hasAdminRole() {
      return request.auth != null &&
             get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.role == 'admin';
    }

    function hasFullAccess() {
      return isAdmin() || isAgentUser() || hasAdminRole();
    }
  }
}
